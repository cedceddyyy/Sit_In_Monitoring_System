{% extends "admin_base.html" %}

{% block content %}
<div class="w3-container w3-padding-16 w3-margin w3-animate-bottom">

    <!-- Pie Charts -->
    <div class="w3-row-padding w3-margin-top">
        <div class="w3-half">
            <div class="modern-card"
                style="height: 400px; display: flex; justify-content: center; align-items: center;">
                <div class="modern-card-body" style="width: 100%; height: 100%; padding: 20px;">
                    <canvas id="purposePieChart" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>
        </div>
        <div class="w3-half">
            <div class="modern-card"
                style="height: 400px; display: flex; justify-content: center; align-items: center;">
                <div class="modern-card-body" style="width: 100%; height: 100%; padding: 20px;">
                    <canvas id="labBarChart" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Rows per page -->
    <div class="w3-bar w3-margin">
        <label for="rowsPerPage" class="w3-text-grey">Rows per page: </label>
        <select id="rowsPerPage" class="w3-select w3-border w3-round" style="max-width: 50px;">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
        </select>
    </div>

    <!-- Search bar -->
    <div class="w3-bar w3-margin-bottom">
        <form method="GET" action="{{ url_for('view_sit_in') }}" class="w3-row"
            style="max-width: 600px; margin: 0 auto; display: flex;">
            <input class="w3-input w3-border w3-round" type="text" name="search" placeholder="Search by ID or Purpose"
                style="flex: 1;" value="{{ request.args.get('search', '') }}">
            <button class="w3-button w3-round" type="submit"
                style="background-color: var(--primary-color); color: white; margin-left: 10px;">
                <i class="material-icons">search</i>
            </button>
        </form>
    </div>

    <!-- Table -->
    <div class="modern-card w3-round">
        <div class="modern-card-body">
            <table class="w3-table w3-bordered w3-hoverable">
                <thead class="w3-light-grey">
                    <tr style="color: var(--primary-color);">
                        <th>ID No</th>
                        <th>Full Name</th>
                        <th>Purpose</th>
                        <th>Lab</th>
                        <th>Login Time</th>
                        <th>Logout Time</th>
                        <th>Date</th>
                        <th>Points</th> <!-- New column for points -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for record in sit_in_records %}
                    <tr>
                        <td>{{ record.idno }}</td>
                        <td>{{ record.full_name }}</td>
                        <td>{{ record.purpose }}</td>
                        <td>{{ record.lab }}</td>
                        <td>{{ record.login_time }}</td>
                        <td>{{ record.logout_time if record.logout_time else "N/A" }}</td>
                        <td>{{ record.date }}</td>
                        <td>{{ record.points }}</td> <!-- Display points -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="w3-bar w3-center w3-padding w3-margin">
        <a href="#" class="w3-button" id="prevPage">«</a>
        <a href="#" class="w3-button" id="page1">1</a>
        <a href="#" class="w3-button" id="page2">2</a>
        <a href="#" class="w3-button" id="page3">3</a>
        <a href="#" class="w3-button" id="page4">4</a>
        <a href="#" class="w3-button" id="nextPage">»</a>
    </div>
</div>

<!-- JavaScript to handle rows per page and pagination -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Pagination Logic ---
        let currentPage = 1;
        let rowsPerPage = 5;
        const tableBody = document.getElementById('tableBody');
        const rows = Array.from(tableBody.getElementsByTagName('tr')); // Dynamic collection to array
        const totalRows = rows.length;
        const rowsPerPageSelect = document.getElementById('rowsPerPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        // Select all numbered page buttons
        // Note: This relies on the buttons existing in HTML. If dynamic generation is needed, this logic needs change.
        // For now, we update existing buttons visibility.

        function updateTable() {
            const startRow = (currentPage - 1) * rowsPerPage;
            const endRow = startRow + rowsPerPage;

            rows.forEach((row, index) => {
                if (index >= startRow && index < endRow) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updatePaginationUI();
        }

        function updatePaginationUI() {
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;

            // Update numbered buttons
            const pageButtons = document.querySelectorAll('.w3-button[id^="page"]');
            pageButtons.forEach((button, index) => {
                const pageNum = index + 1;
                if (pageNum <= totalPages) {
                    button.style.display = 'inline-block';
                    // Highlight current page
                    if (pageNum === currentPage) {
                        button.classList.add('w3-deep-purple', 'w3-text-white');
                        button.classList.remove('w3-hover-gray');
                    } else {
                        button.classList.remove('w3-deep-purple', 'w3-text-white');
                        button.classList.add('w3-hover-gray');
                    }
                } else {
                    button.style.display = 'none';
                }
            });

            // Update Prev/Next State
            if (currentPage <= 1) {
                prevPageBtn.classList.add('w3-disabled');
                prevPageBtn.style.pointerEvents = 'none';
            } else {
                prevPageBtn.classList.remove('w3-disabled');
                prevPageBtn.style.pointerEvents = 'auto';
            }

            if (currentPage >= totalPages) {
                nextPageBtn.classList.add('w3-disabled');
                nextPageBtn.style.pointerEvents = 'none';
            } else {
                nextPageBtn.classList.remove('w3-disabled');
                nextPageBtn.style.pointerEvents = 'auto';
            }
        }

        // Event Listeners
        rowsPerPageSelect.addEventListener('change', function () {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            updateTable();
        });

        prevPageBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });

        nextPageBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        });

        // Page Number Clicks
        document.querySelectorAll('.w3-button[id^="page"]').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const pageNum = parseInt(this.textContent);
                if (!isNaN(pageNum)) {
                    currentPage = pageNum;
                    updateTable();
                }
            });
        });

        // Initialize Pagination
        updateTable();


        // --- Chart Logic ---
        try {
            // Safe data passing using tojson
            const purposeCounts = {{ purpose_counts | tojson
        }};
    const labCounts = {{ lab_counts | tojson }};

    // Prepare Purpose Data
    let purposeLabels = [];
    let purposeValues = [];
    if (purposeCounts && Object.keys(purposeCounts).length > 0) {
        purposeLabels = Object.keys(purposeCounts);
        purposeValues = Object.values(purposeCounts);
    } else {
        purposeLabels = ['No Data'];
        purposeValues = [1];
    }

    // Prepare Lab Data
    let labLabels = [];
    let labValues = [];
    if (labCounts && Object.keys(labCounts).length > 0) {
        labLabels = Object.keys(labCounts);
        labValues = Object.values(labCounts);
    } else {
        labLabels = ['No Data'];
        labValues = [1];
    }

    // Draw Purpose Pie Chart
    const purposeCtx = document.getElementById('purposePieChart').getContext('2d');
    new Chart(purposeCtx, {
        type: 'pie',
        data: {
            labels: purposeLabels,
            datasets: [{
                data: purposeValues,
                backgroundColor: ['#6A0DAD', '#8A2BE2', '#9370DB', '#D8BFD8', '#DDA0DD', '#E6E6FA', '#F0E68C', '#FFFACD', '#FFEFD5', '#FFDAB9']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Sit-In Purposes Breakdown' }
            }
        }
    });

    // Draw Lab Bar Chart
    const labCtx = document.getElementById('labBarChart').getContext('2d');
    new Chart(labCtx, {
        type: 'bar',
        data: {
            labels: labLabels,
            datasets: [{
                label: 'Sit-ins Count',
                data: labValues,
                backgroundColor: '#FFDE91'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Sit-In Labs Breakdown' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    } catch (error) {
        console.error("Error creating charts:", error);
    }
});
</script>
{% endblock %}