{% extends "base.html" %}

{% block content %}
<div class="w3-container">
    <!-- Calendar Section -->
    <div class="w3-card w3-padding" style="max-width: 1000px; margin: auto; margin-bottom: 20px;">
        <h2 class="w3-center font-color">Monthly Schedule</h2>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <button class="w3-button w3-round-large prev-month color font-color">&lt;</button>
                <h3 class="calendar-month w3-center font-color"></h3>
                <button class="w3-button w3-round-large next-month color font-color">&gt;</button>
            </div>
            
            <div class="calendar-weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            
            <div class="calendar-days"></div>
        </div>
    </div>

    <!-- Schedule Details Modal -->
    <div id="scheduleModal" class="w3-modal">
        <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width:600px">
            <div class="w3-center">
                <span onclick="document.getElementById('scheduleModal').style.display='none'" 
                      class="w3-button w3-xlarge w3-hover-red w3-display-topright" title="Close Modal">&times;</span>
                <h3 id="modalDate" class="w3-padding w3-text-dark-grey"></h3>
            </div>

            <div class="w3-container w3-padding">
                <div id="scheduleList" class="w3-margin-bottom">
                    <!-- Schedules will be displayed here -->
                </div>
                
                <hr>
                
                <!-- Reservation Form -->
                <h4 class="w3-text-dark-grey">Make a Reservation</h4>
                <form id="reservationForm" method="POST" action="{{ url_for('reservation') }}" class="w3-container">
                    <input type="hidden" name="date" id="reservationDate">
                    
                    <div class="w3-row-padding" style="margin: 0 -16px;">
                        <div class="w3-half w3-margin-bottom">
                            <label class="w3-text-dark-grey"><b>Student ID</b></label>
                            <input class="w3-input w3-border w3-round w3-margin-bottom" 
                                   type="text" name="student_id" value="{{ user.idno }}" readonly>
                        </div>
                        <div class="w3-half w3-margin-bottom">
                            <label class="w3-text-dark-grey"><b>Full Name</b></label>
                            <input class="w3-input w3-border w3-round" 
                                   type="text" name="full_name" value="{{ user.firstname }} {{ user.lastname }}" readonly>
                        </div>
                    </div>

                    <label class="w3-text-dark-grey"><b>Purpose</b></label>
                    <select class="w3-select w3-border w3-round w3-margin-bottom" name="subject" required>
                        <option value="" disabled selected>Select a purpose</option>
                        <option value="C Programming">C Programming</option>
                        <option value="Java Programming">Java Programming</option>
                        <option value="Python">Python</option>
                        <option value="C#">C#</option>
                        <option value="Database">Database</option>
                        <option value="Digital Logic & Design">Digital Logic & Design</option>
                        <option value="Embedded Systems & IoT">Embedded Systems & IoT</option>
                        <option value="System Integration & Architecture">System Integration & Architecture</option>
                        <option value="Computer Application">Computer Application</option>
                        <option value="Project Management">Project Management</option>
                        <option value="IT Trends">IT Trends</option>
                        <option value="Technopreneurship">Technopreneurship</option>
                        <option value="Capstone">Capstone</option>
                    </select>
                    
                    <div class="w3-row-padding" style="margin: 0 -16px;">
                        <div class="w3-half w3-margin-bottom">
                            <label class="w3-text-dark-grey"><b>Time-in</b></label>
                            <input class="w3-input w3-border w3-round" 
                                   type="time" name="time_in" required>
                        </div>
                        <div class="w3-half w3-margin-bottom">
                            <label class="w3-text-dark-grey"><b>Lab</b></label>
                            <select class="w3-select w3-border w3-round" name="room" id="lab-select" required onchange="loadAvailablePCs()">
                                <option value="" disabled selected>Select a lab</option>
                                <option value="524">524</option>
                                <option value="526">526</option>
                                <option value="528">528</option>
                                <option value="530">530</option>
                                <option value="542">542</option>
                                <option value="544">544</option>
                                <option value="517">517</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dropdown for Available PCs -->
                    <div id="pc-dropdown-container" style="display: none;">
                        <label class="w3-text-dark-grey"><b>Available PCs</b></label>
                        <select class="w3-select w3-border w3-round w3-margin-bottom" name="pc" id="pc-select" required>
                            <option value="" disabled selected>Select a PC</option>
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    
                    <div class="w3-half w3-margin-bottom">
                        <label class="w3-text-dark-grey"><b>Remaining Session</b></label>
                        <input class="w3-input w3-border w3-round" 
                               type="number" name="session" value="{{ user.session }}" readonly>
                    </div>
                    
                    <button class="w3-button w3-round w3-margin-top w3-block" 
                        style="background-color: #FFDE91; color: #2C1038;" 
                        type="submit">
                        <i class="material-icons" style="vertical-align: middle;">event_available</i> Reserve
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .calendar-container {
        font-family: 'Work Sans', sans-serif;
        max-width: 800px;
        margin: 20px auto;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: 500;
        margin-bottom: 10px;
    }
    
    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-day {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        position: relative;
        padding: 5px;
    }
    
    .calendar-day:hover {
        background-color: #f0f0f0;
    }
    
    .calendar-day.empty {
        background-color: transparent;
        cursor: default;
    }
    
    .calendar-day.today {
        background-color: #D3BAFA;
        font-weight: bold;
    }
    
    .calendar-day .event {
        position: absolute;
        bottom: 2px;
        font-size: 10px;
        background: #9c27b0;
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
        width: calc(100% - 8px);
        text-align: center;
    }
    
    .schedule-item {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #9c27b0;
        background-color: #f9f9f9;
    }
    
    .schedule-time {
        font-weight: bold;
        color: #9c27b0;
    }
    
    .schedule-lab {
        font-weight: bold;
    }
</style>

<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script>
    // Month names array
    const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];

    // Track current displayed month and year
    let currentDisplayedMonth = new Date().getMonth();
    let currentDisplayedYear = new Date().getFullYear();

    // Function to load available PCs based on the selected lab
    function loadAvailablePCs() {
        const labSelect = document.getElementById("lab-select");
        const pcDropdownContainer = document.getElementById("pc-dropdown-container");
        const pcSelect = document.getElementById("pc-select");

        const selectedLab = labSelect.value;

        if (selectedLab) {
            fetch(`/get_pc_status/${selectedLab}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        pcSelect.innerHTML = '<option value="" disabled selected>Select a PC</option>';
                        data.pcs.forEach(pc => {
                            if (pc.status === "available") {
                                const option = document.createElement("option");
                                option.value = pc.pc_number;
                                option.textContent = `PC ${pc.pc_number}`;
                                pcSelect.appendChild(option);
                            }
                        });
                        pcDropdownContainer.style.display = "block";
                    } else {
                        alert("Failed to load PCs. Please try again.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching PCs:", error);
                    alert("An error occurred while loading PCs.");
                });
        } else {
            pcDropdownContainer.style.display = "none";
        }
    }

    // Modified calendar.js functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get current date
        const currentDate = new Date();
        const today = {
            date: currentDate.getDate(),
            month: currentDate.getMonth(),
            year: currentDate.getFullYear()
        };

        // Render calendar with current month
        renderCalendar(currentDisplayedMonth, currentDisplayedYear, today);

        // Navigation buttons
        document.querySelector('.prev-month').addEventListener('click', function() {
            currentDisplayedMonth--;
            
            if (currentDisplayedMonth < 0) {
                currentDisplayedMonth = 11;
                currentDisplayedYear--;
            }

            renderCalendar(currentDisplayedMonth, currentDisplayedYear, {
                date: new Date().getDate(),
                month: new Date().getMonth(),
                year: new Date().getFullYear()
            });
        });

        document.querySelector('.next-month').addEventListener('click', function() {
            currentDisplayedMonth++;
            
            if (currentDisplayedMonth > 11) {
                currentDisplayedMonth = 0;
                currentDisplayedYear++;
            }

            renderCalendar(currentDisplayedMonth, currentDisplayedYear, {
                date: new Date().getDate(),
                month: new Date().getMonth(),
                year: new Date().getFullYear()
            });
        });
    });

    function renderCalendar(month, year, today) {
        // Set month and year header
        document.querySelector('.calendar-month').textContent = `${monthNames[month]} ${year}`;
        
        // Get first day of month and total days in month
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Clear previous days
        const daysContainer = document.querySelector('.calendar-days');
        daysContainer.innerHTML = '';
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            daysContainer.appendChild(emptyDay);
        }
        
        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            
            // Highlight current day
            if (day === today.date && month === today.month && year === today.year) {
                dayElement.classList.add('today');
            }
            
            // Add click event to show schedules for the day
            dayElement.addEventListener('click', function() {
                showSchedulesForDate(year, month + 1, day);
            });
            
            // Check if this day has any schedules
            checkDayForSchedules(year, month + 1, day, dayElement);
            
            daysContainer.appendChild(dayElement);
        }
    }

    function checkDayForSchedules(year, month, day, dayElement) {
        // Format date as YYYY-MM-DD
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        
        fetch(`/get_schedules_by_date?date=${dateStr}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.schedules.length > 0) {
                    // Add indicator that this day has schedules
                    const eventIndicator = document.createElement('div');
                    eventIndicator.className = 'event';
                    eventIndicator.textContent = `${data.schedules.length} schedule(s)`;
                    dayElement.appendChild(eventIndicator);
                }
            });
    }

    function showSchedulesForDate(year, month, day) {
        // Format date as YYYY-MM-DD
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const formattedDate = `${month}/${day}/${year}`;
        
        // Set the modal title
        document.getElementById('modalDate').textContent = `Schedules for ${formattedDate}`;
        
        // Set the hidden date field in the reservation form
        document.getElementById('reservationDate').value = dateStr;
        
        // Fetch schedules for this date
        fetch(`/get_schedules_by_date?date=${dateStr}`)
            .then(response => response.json())
            .then(data => {
                const scheduleList = document.getElementById('scheduleList');
                scheduleList.innerHTML = '';
                
                if (data.success && data.schedules.length > 0) {
                    data.schedules.forEach(schedule => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        scheduleItem.innerHTML = `
                            <div class="schedule-time">${schedule.time_start} - ${schedule.time_end}</div>
                            <div class="schedule-lab">Lab ${schedule.lab_number}</div>
                            <div>${schedule.purpose}</div>
                        `;
                        scheduleList.appendChild(scheduleItem);
                    });
                } else {
                    scheduleList.innerHTML = '<p>No schedules for this day.</p>';
                }
                
                // Show the modal
                document.getElementById('scheduleModal').style.display = 'block';
            });
    }
</script>
{% endblock %}